{% extends "layout.html" %}

{% block scripts %}
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.0/es5/tex-svg.js"></script>

<script>

let pasteContent = [];
let startTime = Date.now(); // Time when tab was focused
let elapsedTime = 0; // Cumulative time

function addPaste(content) {
  pasteContent.push(content.text);
  return content;
}

function focus() {
  startTime = Date.now();
}

function blur() {
  dt = Date.now() - startTime
  elapsedTime += dt;
}

function findDiffLine(str1, str2) {
    let line = 1;
    for (i = 0; i < str2.length; i++) {
        if (str2.charAt(i) !== str1.charAt(i))
            return line;
        if (str1.charAt(i) === "\n")
            line++;
    }
    return -1;
}

function compile(buttonId) {
  // Set the build text to "building"
  outputlog = document.getElementById("buildlog");
  outputlog.hidden = false;
  document.getElementById("schematic").src = "/static/images/schematic_loading.svg";
  document.getElementById("schematicblock").hidden = true;

  // Read the code from the form
  var code = editor.getValue();
  var code_clean = code;

  // Replace &nbsp; space with normal space
  code = code.replace(/\u00a0/g, ' ');
  if (code !== code_clean) {
      var diffLine = findDiffLine(code, code_clean);
      outputlog.innerHTML = `Replaced nbsp on line ${diffLine} with normal space`;
      editor.setValue(code);
      code_clean = code;
  }

  // check for other weird characters and stop of they exist
  code = code.replace(/[^\x00-\x7F]/g, "");
  if (code !== code_clean) {
      var diffLine = findDiffLine(code, code_clean);
      outputlog.innerHTML = `Cannot replace non-ASCII character on line ${diffLine}!`;
      return;
  }

  // Send the code to the server
  if (code.length == 0) {
      outputlog.innerHTML = "No code to compile!";
      return;
  } else {
      var xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
              result = JSON.parse(this.responseText);
              document.getElementById("buildlog").innerHTML = "<pre>" + result.buildOutput + "</pre>";
              if (result.netlist) {
                document.getElementById("schematic").src = result.netlist;
                document.getElementById("schematicblock").hidden = false;
              }
          }
      };

      dt = Date.now() - startTime;
      elapsedTime += dt;

      xmlhttp.open("POST", "/compile/", true);
      xmlhttp.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
      var blob = JSON.stringify({"code":code, "button":buttonId, "pagetime":elapsedTime/1000, "pastes":pasteContent});
      xmlhttp.send(blob);

      pasteContent = []; // Reset for next time
      startTime = Date.now();
      elapsedTime = 0;
  }

  window.addEventListener('focus', focus);
  window.addEventListener('blur', blur);
}
</script>
{% endblock %}

{% block content %}
<p>Converts a VHDL entity into a block diagram using GHDL, Yosys, and netlistsvg. Top entity must be named top.</p>

<br>

<div id="editor">
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    // editor.setTheme("ace/theme/xcode");
    editor.session.setMode("ace/mode/vhdl");
    document.getElementById("editor").style.fontSize='16px';
    editor.on("paste", addPaste);
</script>

<br>
<br>

<span align="right">
<button onClick="compile('confident')">Generate Block Diagram</button>
</span>

<br>
<br>

<h3 id="buildlabel" hidden="true">Compiler output</h3>
<span id="buildlog">
</span>

<div id="schematicblock" hidden="true">
<img id="schematic"></img>
</div>

{% endblock %}
